pipeline {
    agent any

    environment {
        APP_DIR = "/opt/dotnet-app"
        APP_PORT = "5248"
        APP_LOG = "/var/log/app.log"

        MYSQL_ROOT_PASSWORD = "Ganesha-123456"
        MYSQL_PORT = "3306"
    }

    stages {

        stage('Start MySQL') {
            steps {
                sh '''
                    echo "Starting MySQL container..."
                    docker run -d --name my-mysql \
                        -e MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD \
                        -p $MYSQL_PORT:3306 \
                        mysql:8.0

                    echo "Waiting for MySQL to be ready..."
                    sleep 20
                '''
            }
        }

        stage('Build & Publish') {
            agent {
                docker {
                    image 'mcr.microsoft.com/dotnet/sdk:7.0'
                    args '-u root'
                }
            }
            environment {
                DOTNET_CLI_HOME = "${WORKSPACE}"
            }
            steps {
                sh '''
                    echo "Workspace:"
                    pwd
                    ls -l

                    echo "Restoring .NET project..."
                    dotnet restore LSQ.csproj

                    echo "Publishing .NET project..."
                    dotnet publish LSQ.csproj -c Release -o publish
                '''
                stash name: 'app', includes: 'publish/**'
            }
        }

        stage('Deploy App') {
            steps {
                unstash 'app'
                sh '''
                    echo "Deploying app..."
                    mkdir -p $APP_DIR
                    cp -r publish/* $APP_DIR/

                    echo "Stopping existing app..."
                    pkill -f LSQ.dll || true

                    echo "Starting app..."
                    nohup dotnet $APP_DIR/LSQ.dll > $APP_LOG 2>&1 &

                    sleep 5
                '''
            }
        }

        stage('Verify API') {
            steps {
                sh '''
                    echo "Verifying API..."
                    curl -v http://localhost:$APP_PORT/api/login
                '''
            }
        }

        stage('Verify MySQL') {
            steps {
                sh '''
                    echo "Verifying MySQL..."
                    docker exec my-mysql mysql -u root -p"$MYSQL_ROOT_PASSWORD" -e "SHOW DATABASES;"
                '''
            }
        }
    }

    post {
        always {
            sh 'docker stop my-mysql || true'
            sh 'docker rm my-mysql || true'
            echo "Pipeline finished."
        }
    }
}
